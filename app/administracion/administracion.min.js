(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(Q,e,i,J,p,x,m,q,y,D,l,g,O,H,F){var r=this;r.screen=l.screen;r.usuarios=[];r.usuario={usuario_id:-1};r.user=Q.getFromToken();r.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};r.proyectos=[];r.showJustificaciones=false;r.foto_01="";r.foto_02="";r.foto_03="";r.foto_04="";r.donaciones_entregadas=[];r.donaciones_obtenidas=[];r.cambios=[];r.padres=[];r.categoria={};r.proyecto_categoria=-1;r.donaciones=[];r.foto_01="no_image.png";r.foto_02="no_image.png";r.foto_03="no_image.png";r.foto_04="no_image.png";r.validation=true;r.modificarUsuario=z;r.resetUsuario=k;r.saveUsuario=n;r.removeUsuario=N;r.updateUsuario=j;r.modificarProyecto=f;r.resetProyecto=E;r.confirmarProyecto=v;r.removeProyecto=t;r.createProyecto=I;r.createCambio=K;r.updateFotoProyecto=G;r.selectCambio=C;r.confirmarCambio=w;r.negarCambio=L;r.modificarCategoria=s;r.saveCategoria=M;r.removeCategoria=B;r.resetCategoria=A;r.aprobarDonacion=h;r.subirComprobante=P;if(Q.getFromToken()==false){J.path("/ingreso")}m.$watch("administracionCtrl.screen",function(S,R){if(S=="administracion/datos.html"){if(r.user.data!=undefined&&r.user.data.rol=="0"){Q.getByParams("marcado","0","true",function(T){r.usuarios=T;r.usuario.rol_id="1"})}else{r.usuario=Q.getLogged()}}if(S=="administracion/patrocinadores.html"||S=="administracion/aportes.html"){y.clearCache=true;r.donaciones_entregadas=[];r.donaciones_obtenidas=[];q.get(r.user.data.id,function(U){for(var T=0;T<U.length;T++){if(U[T].donador_id==r.user.data.id){r.donaciones_entregadas.push(U[T])}else{r.donaciones_obtenidas.push(U[T])}}})}if(S=="administracion/proyectos.html"){D.get(function(T){r.categorias=T;r.proyecto_categoria=T[0].categoria_id});if(r.user.data.rol==0){F.activos=false;F.clearCache=true;i.get(function(T){if(T.length>0){o(T)}})}else{i.getByParams("usuario_id",""+r.user.data.id,"true",function(T){if(T.length>0){o(T)}})}}if(S=="administracion/cambios.html"){i.getCambios(function(U){console.log(U);for(var T=0;T<U.length;T++){if(U[T].fotos!="[]"){U[T].fotos=JSON.parse(U[T].fotos)}}r.cambios=U})}if(S=="administracion/categorias.html"){D.get(function(T){r.categorias=T;r.categoria.categoria_id=-1});D.getByParams("parent_id","-1","true",function(T){r.padres=T})}if(S=="administracion/donaciones.html"){q.get(-1,function(T){r.donaciones=T})}});function u(){r.validation=false;H(function(){r.validation=true},1)}function o(S){for(var R=0;R<S.length;R++){S[R].costo_inicial=parseFloat(S[R].costo_inicial);S[R].total_donado=parseFloat(S[R].total_donado);S[R].fecha_inicio=new Date(S[R].fecha_inicio);S[R].fecha_fin=new Date(S[R].fecha_fin);if(S[R].status==1){S[R].statusTexto="Activo"}if(S[R].status==0){S[R].statusTexto="Baja"}if(S[R].status==2){S[R].statusTexto="Terminado"}if(S[R].status==3){S[R].statusTexto="Dinero Transferido"}if(S[R].status==4){S[R].statusTexto="Pendiente de Aprobación"}S[R].status=""+S[R].status}r.proyectos=S}function z(S){g.broadcast();r.usuario=angular.copy(S);r.usuario.rol_id=""+r.usuario.rol_id;r.usuario.calle=""+r.usuario.direcciones[0].calle;var R=angular.element(document.querySelector("#nombre"))}function k(){r.usuario={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function n(){}function N(){if(r.usuario.usuario_id==-1){return}var R=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!R){return}r.usuario.marcado=1;Q.update(r.usuario,function(S){Q.getByParams("marcado","0","true",function(T){r.usuarios=T;k();u()})})}function j(){if(r.user.data.rol!=0){r.usuario.rol_id=r.user.data.rol}if(r.usuario.usuario_id==-1){return}Q.update(r.usuario,function(R){if(r.user.data.rol==0){Q.getByParams("marcado","0","true",function(S){r.usuarios=S;k();u();e.showMessage("success","Datos Guardados con Éxito")})}else{r.usuario.password="";Q.setLogged(r.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(S){g.broadcast();r.proyecto=angular.copy(S);r.proyecto.en_slider=""+r.proyecto.en_slider;r.proyecto_categoria=r.proyecto.categoria_id;var R=angular.element(document.querySelector("#nombre"));r.foto_01=(r.proyecto.fotos[0]!=undefined)?r.proyecto.fotos[0].nombre:"no_image.png";r.foto_02=(r.proyecto.fotos[1]!=undefined)?r.proyecto.fotos[1].nombre:"no_image.png";r.foto_03=(r.proyecto.fotos[2]!=undefined)?r.proyecto.fotos[2].nombre:"no_image.png";r.foto_04=(r.proyecto.fotos[3]!=undefined)?r.proyecto.fotos[3].nombre:"no_image.png";R[0].focus();r.proyecto_categoria=r.proyecto.categoria_id}function E(){r.proyecto={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"1",status:-1};r.foto_01="no_image.png";r.foto_02="no_image.png";r.foto_03="no_image.png";r.foto_04="no_image.png";r.showJustificaciones=false}function t(){if(r.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var R=confirm("La eleminación de un proyecto debe ser aprobada por un administrador. Desea continuar?");if(!R){return}if(r.proyecto.proyecto_id!=-1){r.showJustificaciones=true;r.proyecto.status=0;return}}function v(){if(r.proyecto.proyecto_id==-1){return}r.proyecto.status=1;r.proyecto.categorias=[{categoria_id:r.proyecto_categoria}];i.update(r.proyecto,function(R){F.clearCache=true;i.get(function(S){if(S.length>0){o(S);E();O.sendMail("arielcessario@gmail.com",[{mail:r.user.data.mail}],"MPE","CONFIRMACIÓN DE PROYECTO - Proyecto "+r.proyecto.nombre,"Se aprobó el proyecto",function(T){console.log(T)})}})})}function K(){var S="[";for(var R=0;R<r.proyecto.fotos.length;R++){S=S+'{"main":"0","nombre":"'+r.proyecto.fotos[R].nombre+'","folder":"","proyecto_id":"'+r.proyecto.proyecto_id+'"},'}S=S.substring(0,S.length-1);S=S+"]";r.proyecto.fotos=S;r.proyecto.fecha_fin=new Date((r.proyecto.fecha_fin.getMonth()+1)+"/"+(r.proyecto.fecha_fin.getDate())+"/"+r.proyecto.fecha_fin.getFullYear());r.proyecto.status_cambio=1;r.proyecto.usuario_id=r.user.data.id;r.proyecto.categorias=r.proyecto_categoria;i.createCambio(r.proyecto,function(T){x.uploadsList=[];r.proyecto={proyecto_id:-1};r.showJustificaciones=false;u();O.sendMail(r.user.data.mail,[{mail:"arielcessario@gmail.com"}],"MPE","CREACIÓN DE CAMBIO - Proyecto "+r.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(U){console.log(U)})})}function I(){r.proyecto.fotos=[{main:0,nombre:r.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:r.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:r.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:r.foto_04,carpeta:"",proyecto_id:-1}];r.proyecto.categorias=[{categoria_id:r.proyecto_categoria}];r.proyecto.fecha_fin=new Date((r.proyecto.fecha_fin.getMonth()+1)+"/"+(r.proyecto.fecha_fin.getDate())+"/"+r.proyecto.fecha_fin.getFullYear());r.proyecto.usuario_id=r.user.data.id;if(r.proyecto.proyecto_id!=-1){r.showJustificaciones=true;return}r.proyecto.status=4;i.create(r.proyecto,function(R){e.showMessage("success","El proyecto ha sido creado, por favor aguarde la aprobación del administrador. Gracias.");O.sendMail(r.user.data.mail,[{mail:"arielcessario@gmail.com"}],"MPE","CREACIÓN DE NUEVO PROYECTO - Proyecto "+r.proyecto.nombre,"Existe un nuevo proyecto para aprobar",function(S){console.log(S)});if(r.user.data.rol=="0"){i.get(function(S){o(S);x.uploadsList=[];r.proyecto={proyecto_id:-1};u()})}else{i.getByParams("usuario_id",""+r.user.data.id,"true",function(S){if(S.length>0){o(S);E()}u()})}})}function G(R,T,S){p.addImages(R,T,S,function(V){for(var U=0;U<x.uploadsList.length;U++){if(x.uploadsList[U].id==1){r.foto_01=x.uploadsList[U].file.name}if(x.uploadsList[U].id==2){r.foto_02=x.uploadsList[U].file.name}if(x.uploadsList[U].id==3){r.foto_03=x.uploadsList[U].file.name}if(x.uploadsList[U].id==4){r.foto_04=x.uploadsList[U].file.name}}m.$apply()})}function C(R){r.proyecto_modificado=R;i.getByParams("proyecto_id",""+R.proyecto_id,""+true,function(S){r.proyecto_original=S[0]})}function w(){r.proyecto_modificado.status_cambio=2;r.proyecto_modificado.categorias=[{categoria_id:r.proyecto_modificado.categorias}];console.log(r.proyecto_modificado);i.updateCambio(r.proyecto_modificado,function(R){if(R!=-1){i.update(r.proyecto_modificado,function(S){i.getCambios(function(T){O.sendMail(r.user.data.mail,[{mail:r.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+r.proyecto.nombre,"Su cambio ha sido aprobado",function(U){console.log(U)});r.cambios=T;r.proyecto_original={};r.proyecto_modificado={};u()})})}})}function L(){r.proyecto_modificado.status_cambio=0;i.updateCambio(r.proyecto_modificado,function(R){i.getCambios(function(S){O.sendMail(r.user.data.mail,[{mail:r.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+r.proyecto.nombre,"Su cambio ha sido cancelado",function(T){console.log(T)});r.cambios=S;r.proyecto_original={};r.proyecto_modificado={};u()})})}function B(){console.log(r.categoria);if(r.categoria.categoria_id==-1){e.showMessage("error","No ha seleccionado una categoría.");return}var R=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(R){categoria;D.update(r.categoria,function(S){})}}function s(S){r.categoria=angular.copy(S);var R=angular.element(document.querySelector("#nombre-categoria"));R[0].focus()}function M(){if(r.categoria.parent_id==undefined){r.categoria.parent_id=-1}if(r.categoria.categoria_id!=-1){D.update(r.categoria,function(R){if(R=="true"){D.get(function(S){r.categorias=S;u()});D.getByParams("parent_id","-1","true",function(S){r.padres=S;u()})}else{}})}else{D.create(r.categoria,function(R){D.get(function(S){r.categorias=S;u()});D.getByParams("parent_id","-1","true",function(S){r.padres=S;u()})})}r.categoria={};r.categoria.categoria_id=-1}function h(R){if(!r.user){J.path("/ingreso");return}R.status=1;q.update(R,function(S){O.sendMail("arielcessario@gmail.com",[{mail:"arielcessario@gmail.com"}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(U,T){console.log(U);console.log(T)});q.get(-1,function(T){r.donaciones=T;F.clearCache=true;i.get(function(U){})})})}function A(){r.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function P(R){p.uploadImages(R.item(0),"",function(S){i.confirmarDeposito(r.proyecto.proyecto_id,R.item(0).name,function(T){console.log(T);i.get(function(U){r.proyectos=U})})})}}function d(){this.screen="administracion/datos.html"}})();