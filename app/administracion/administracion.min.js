(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(R,e,i,K,q,y,m,r,z,E,l,g,P,I,G){var s=this;s.screen=l.screen;s.usuarios=[];s.usuario={usuario_id:-1};s.user=R.getFromToken();s.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};s.proyectos=[];s.showJustificaciones=false;s.foto_01="";s.foto_02="";s.foto_03="";s.foto_04="";s.donaciones_entregadas=[];s.donaciones_obtenidas=[];s.cambios=[];s.padres=[];s.categoria={};s.proyecto_categoria=-1;s.donaciones=[];s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.validation=true;s.modificarUsuario=A;s.resetUsuario=k;s.saveUsuario=n;s.removeUsuario=O;s.updateUsuario=j;s.modificarProyecto=f;s.resetProyecto=F;s.confirmarProyecto=w;s.removeProyecto=u;s.createProyecto=J;s.createCambio=L;s.updateFotoProyecto=H;s.selectCambio=D;s.confirmarCambio=x;s.negarCambio=M;s.modificarCategoria=t;s.saveCategoria=N;s.removeCategoria=C;s.resetCategoria=B;s.aprobarDonacion=h;s.cancelarDonacion=o;s.subirComprobante=Q;if(R.getFromToken()==false){K.path("/ingreso")}m.$watch("administracionCtrl.screen",function(T,S){if(T=="administracion/datos.html"){if(s.user.data!=undefined&&s.user.data.rol=="0"){R.getByParams("marcado","0","true",function(U){s.usuarios=U;s.usuario.rol_id="1"})}else{s.usuario=R.getLogged()}}if(T=="administracion/patrocinadores.html"||T=="administracion/aportes.html"){z.clearCache=true;s.donaciones_entregadas=[];s.donaciones_obtenidas=[];r.get(s.user.data.id,function(V){for(var U=0;U<V.length;U++){if(V[U].donador_id==s.user.data.id){s.donaciones_entregadas.push(V[U])}else{s.donaciones_obtenidas.push(V[U])}}})}if(T=="administracion/proyectos.html"){E.get(function(U){s.categorias=U;s.proyecto_categoria=U[0].categoria_id});if(s.user.data.rol==0){G.activos=false;G.clearCache=true;i.get(function(U){if(U.length>0){p(U)}})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(U){if(U.length>0){p(U)}})}}if(T=="administracion/cambios.html"){i.getCambios(function(V){console.log(V);for(var U=0;U<V.length;U++){if(V[U].fotos!="[]"){V[U].fotos=JSON.parse(V[U].fotos)}}s.cambios=V})}if(T=="administracion/categorias.html"){E.get(function(U){s.categorias=U;s.categoria.categoria_id=-1});E.getByParams("parent_id","-1","true",function(U){s.padres=U})}if(T=="administracion/donaciones.html"){r.get(-1,function(U){s.donaciones=U})}});function v(){s.validation=false;I(function(){s.validation=true},1)}function p(T){for(var S=0;S<T.length;S++){T[S].costo_inicial=parseFloat(T[S].costo_inicial);T[S].total_donado=parseFloat(T[S].total_donado);T[S].fecha_inicio=new Date(T[S].fecha_inicio);T[S].fecha_fin=new Date(T[S].fecha_fin);if(T[S].status==1){T[S].statusTexto="Activo"}if(T[S].status==0){T[S].statusTexto="Baja"}if(T[S].status==2){T[S].statusTexto="Terminado"}if(T[S].status==3){T[S].statusTexto="Dinero Transferido"}if(T[S].status==4){T[S].statusTexto="Pendiente de Aprobación"}T[S].status=""+T[S].status}s.proyectos=T}function A(T){g.broadcast();s.usuario=angular.copy(T);s.usuario.rol_id=""+s.usuario.rol_id;s.usuario.calle=""+s.usuario.direcciones[0].calle;var S=angular.element(document.querySelector("#nombre"))}function k(){s.usuario={usuario_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function n(){}function O(){if(s.usuario.usuario_id==-1){return}var S=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!S){return}s.usuario.marcado=1;R.update(s.usuario,function(T){R.getByParams("marcado","0","true",function(U){s.usuarios=U;k();v()})})}function j(){if(s.user.data.rol!=0){s.usuario.rol_id=s.user.data.rol}if(s.usuario.usuario_id==-1){return}R.update(s.usuario,function(S){if(s.user.data.rol==0){R.getByParams("marcado","0","true",function(T){s.usuarios=T;k();v();e.showMessage("success","Datos Guardados con Éxito")})}else{s.usuario.password="";R.setLogged(s.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(T){g.broadcast();s.proyecto=angular.copy(T);s.proyecto.en_slider=""+s.proyecto.en_slider;s.proyecto_categoria=s.proyecto.categoria_id;var S=angular.element(document.querySelector("#nombre"));s.foto_01=(s.proyecto.fotos[0]!=undefined)?s.proyecto.fotos[0].nombre:"no_image.png";s.foto_02=(s.proyecto.fotos[1]!=undefined)?s.proyecto.fotos[1].nombre:"no_image.png";s.foto_03=(s.proyecto.fotos[2]!=undefined)?s.proyecto.fotos[2].nombre:"no_image.png";s.foto_04=(s.proyecto.fotos[3]!=undefined)?s.proyecto.fotos[3].nombre:"no_image.png";S[0].focus();s.proyecto_categoria=s.proyecto.categoria_id}function F(){s.proyecto={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"1",status:-1};s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.showJustificaciones=false}function u(){if(s.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var S=confirm("La eleminación de un proyecto debe ser aprobada por un administrador. Desea continuar?");if(!S){return}if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;s.proyecto.status=0;return}}function w(){if(s.proyecto.proyecto_id==-1){return}s.proyecto.status=1;s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];i.update(s.proyecto,function(S){G.clearCache=true;i.get(function(T){if(T.length>0){p(T);F();P.sendMail(window.mailAdmin,[{mail:s.user.data.mail}],"MPE","CONFIRMACIÓN DE PROYECTO - Proyecto "+s.proyecto.nombre,"Se aprobó el proyecto",function(U){console.log(U)})}})})}function L(){var T="[";for(var S=0;S<s.proyecto.fotos.length;S++){T=T+'{"main":"0","nombre":"'+s.proyecto.fotos[S].nombre+'","folder":"","proyecto_id":"'+s.proyecto.proyecto_id+'"},'}T=T.substring(0,T.length-1);T=T+"]";s.proyecto.fotos=T;s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.status_cambio=1;s.proyecto.usuario_id=s.user.data.id;s.proyecto.categorias=s.proyecto_categoria;i.createCambio(s.proyecto,function(U){y.uploadsList=[];s.showJustificaciones=false;v();P.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(V){console.log(V)});s.proyecto={proyecto_id:-1}})}function J(){s.proyecto.fotos=[{main:0,nombre:s.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_04,carpeta:"",proyecto_id:-1}];s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.usuario_id=s.user.data.id;if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;return}s.proyecto.status=4;i.create(s.proyecto,function(S){e.showMessage("success","El proyecto ha sido creado, por favor aguarde la aprobación del administrador. Gracias.");P.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE NUEVO PROYECTO - Proyecto "+s.proyecto.nombre,"Existe un nuevo proyecto para aprobar",function(T){console.log(T)});if(s.user.data.rol=="0"){i.get(function(T){p(T);y.uploadsList=[];F();v()})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(T){if(T.length>0){p(T)}F();v()})}})}function H(S,U,T){q.addImages(S,U,T,function(W){for(var V=0;V<y.uploadsList.length;V++){if(y.uploadsList[V].id==1){s.foto_01=y.uploadsList[V].file.name}if(y.uploadsList[V].id==2){s.foto_02=y.uploadsList[V].file.name}if(y.uploadsList[V].id==3){s.foto_03=y.uploadsList[V].file.name}if(y.uploadsList[V].id==4){s.foto_04=y.uploadsList[V].file.name}}m.$apply()})}function D(S){s.proyecto_modificado=S;i.getByParams("proyecto_id",""+S.proyecto_id,""+true,function(T){s.proyecto_original=T[0]})}function x(){if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=2;s.proyecto_modificado.aprobador_id=s.user.data.id;s.proyecto_modificado.categorias=[{categoria_id:s.proyecto_modificado.categorias}];console.log(s.proyecto_modificado);i.updateCambio(s.proyecto_modificado,function(S){if(S!=-1){i.update(s.proyecto_modificado,function(T){i.getCambios(function(U){P.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido aprobado",function(V){console.log(V)});s.cambios=U;s.proyecto_original={};s.proyecto_modificado={};v()})})}})}function M(){if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=0;s.proyecto_modificado.aprobador_id=s.user.data.id;i.updateCambio(s.proyecto_modificado,function(S){i.getCambios(function(T){P.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido cancelado",function(U){console.log(U)});s.cambios=T;s.proyecto_original={};s.proyecto_modificado={};v()})})}function C(){console.log(s.categoria);if(s.categoria.categoria_id==-1){e.showMessage("error","No ha seleccionado una categoría.");return}var S=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(S){categoria;E.update(s.categoria,function(T){})}}function t(T){s.categoria=angular.copy(T);var S=angular.element(document.querySelector("#nombre-categoria"));S[0].focus()}function N(){if(s.categoria.parent_id==undefined){s.categoria.parent_id=-1}if(s.categoria.categoria_id!=-1){E.update(s.categoria,function(S){if(S=="true"){E.get(function(T){s.categorias=T;v()});E.getByParams("parent_id","-1","true",function(T){s.padres=T;v()})}else{}})}else{E.create(s.categoria,function(S){E.get(function(T){s.categorias=T;v()});E.getByParams("parent_id","-1","true",function(T){s.padres=T;v()})})}s.categoria={};s.categoria.categoria_id=-1}function h(S){if(!s.user){K.path("/ingreso");return}S.status=1;r.update(S,function(T){R.getByParams("usuario_id",""+S.donador_id,"true",function(U){P.sendMail(window.mailAdmin,[{mail:U[0].mail}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(W,V){console.log(W);console.log(V)})});r.get(-1,function(U){s.donaciones=U;G.clearCache=true;i.get(function(V){})})})}function o(S){if(!s.user){K.path("/ingreso");return}S.status=2;r.update(S,function(T){R.getByParams("usuario_id",""+S.donador_id,"true",function(U){P.sendMail(window.mailAdmin,[{mail:U[0].mail}],"Ariel","PRUEBA","PRUEBA DE CANCELACIÓN DE DONACIÓN",function(W,V){console.log(W);console.log(V)})});r.get(-1,function(U){s.donaciones=U;G.clearCache=true;i.get(function(V){})})})}function B(){s.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function Q(S){q.uploadImages(S.item(0),"",function(T){i.confirmarDeposito(s.proyecto.proyecto_id,S.item(0).name,function(U){console.log(U);i.get(function(V){s.proyectos=V})})})}}function d(){this.screen="administracion/datos.html"}})();