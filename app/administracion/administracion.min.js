(function(){"use strict";var scripts=document.getElementsByTagName("script");var currentScriptPath=scripts[scripts.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",AdministracionController).service("AdministracionService",AdministracionService);AdministracionController.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals"];function AdministracionController(UserService,AcUtils,ProyectService,$location,UploadService,UploadVars,$scope,DonationService,DonationVars,CategoryService,AdministracionService,AcUtilsGlobals){var vm=this;vm.screen=AdministracionService.screen;vm.usuarios=[];vm.user=UserService.getFromToken();vm.proyecto={proyecto_id:-1};vm.proyectos=[];vm.showJustificaciones=false;vm.foto_01="";vm.foto_02="";vm.foto_03="";vm.foto_04="";vm.donaciones_entregadas=[];vm.donaciones_obtenidas=[];vm.cambios=[];vm.padres=[];vm.categoria={};vm.proyecto_categoria=-1;vm.donaciones=[];vm.modificarUsuario=modificarUsuario;vm.resetUsuario=resetUsuario;vm.saveUsuario=saveUsuario;vm.removeUsuario=removeUsuario;vm.updateUsuario=updateUsuario;vm.modificarProyecto=modificarProyecto;vm.resetProyecto=resetProyecto;vm.removeProyecto=removeProyecto;vm.createProyecto=createProyecto;vm.createCambio=createCambio;vm.updateFotoProyecto=updateFotoProyecto;vm.selectCambio=selectCambio;vm.confirmarCambio=confirmarCambio;vm.negarCambio=negarCambio;vm.modificarCategoria=modificarCategoria;vm.saveCategoria=saveCategoria;vm.removeCategoria=removeCategoria;vm.aprobarDonacion=aprobarDonacion;if(UserService.getFromToken()==false){$location.path("/ingreso")}$scope.$watch("administracionCtrl.screen",function(newValue,oldValue){if(newValue=="administracion/datos.html"){if(vm.user.data!=undefined&&vm.user.data.rol=="0"){UserService.get(function(data){vm.usuarios=data})}}if(newValue=="administracion/patrocinadores.html"||newValue=="administracion/aportes.html"){DonationVars.clearCache=true;DonationService.get(vm.user.data.id,function(data){for(var i=0;i<data.length;i++){if(data[i].donador_id==vm.user.data.id){vm.donaciones_entregadas.push(data[i])}else{vm.donaciones_obtenidas.push(data[i])}}})}if(newValue=="administracion/proyectos.html"){CategoryService.get(function(data){vm.categorias=data;vm.proyecto_categoria=data[0].categoria_id});ProyectService.get(function(data){if(data.length>0){for(var i=0;i<data.length;i++){data[i].costo_inicial=parseFloat(data[i].costo_inicial);data[i].total_donado=parseFloat(data[i].total_donado);data[i].fecha_inicio=new Date(data[i].fecha_inicio);data[i].fecha_fin=new Date(data[i].fecha_fin);data[i].status=""+data[i].status}vm.proyectos=data}})}if(newValue=="administracion/cambios.html"){ProyectService.getCambios(function(data){for(var i=0;i<data.length;i++){if(data[i].fotos!="[]"){data[i].fotos=JSON.parse(data[i].fotos)}}vm.cambios=data})}if(newValue=="administracion/categorias.html"){CategoryService.get(function(data){vm.categorias=data;vm.categoria.categoria_id=-1});CategoryService.getByParams("parent_id","-1","true",function(data){vm.padres=data})}if(newValue=="administracion/donaciones.html"){DonationService.get(-1,function(data){vm.donaciones=data})}});function modificarUsuario(usuario){vm.usuario=angular.copy(usuario);vm.usuario.rol_id=""+vm.usuario.rol_id;var elem=angular.element(document.querySelector("#nombre"));elem[0].focus()}function resetUsuario(){vm.usuario={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};AcUtilsGlobals.broadcast()}function saveUsuario(){UserService.create(vm.usuario,function(data){UserService.get(function(data){vm.usuarios=data})})}function removeUsuario(){var r=confirm("Realmente desea eliminar el usuario?");if(!r){return}UserService.removeUsuario(vm.usuario.cliente_id,function(data){UserService.get(function(data){vm.usuarios=data})})}function updateUsuario(){var conErrores=false;UserService.update(vm.usuario,function(data){UserService.get(function(data){vm.usuarios=data;vm.usuario={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"}})})}function modificarProyecto(proyecto){console.log(proyecto);vm.proyecto=angular.copy(proyecto);var elem=angular.element(document.querySelector("#nombre"));vm.foto_01=vm.proyecto.fotos[0]!=undefined?vm.proyecto.fotos[0].nombre:"no_image.png";vm.foto_02=vm.proyecto.fotos[1]!=undefined?vm.proyecto.fotos[1].nombre:"no_image.png";vm.foto_03=vm.proyecto.fotos[2]!=undefined?vm.proyecto.fotos[2].nombre:"no_image.png";vm.foto_04=vm.proyecto.fotos[3]!=undefined?vm.proyecto.fotos[3].nombre:"no_image.png";elem[0].focus();vm.proyecto_categoria=vm.proyecto.categoria_id}function resetProyecto(){vm.proyecto={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"}}function removeProyecto(){var r=confirm("Realmente desea eliminar el proyecto?");if(!r){return}ProyectService.removeProyecto(vm.proyecto.cliente_id,function(data){ProyectService.get(function(data){vm.proyectos=data})})}function createCambio(){var jsonFotos="[";for(var i=0;i<vm.proyecto.fotos.length;i++){jsonFotos=jsonFotos+'{"main":"0","nombre":"'+vm.proyecto.fotos[i].nombre+'","folder":"","proyecto_id":"'+vm.proyecto.proyecto_id+'"},'}jsonFotos=jsonFotos.substring(0,jsonFotos.length-1);jsonFotos=jsonFotos+"]";vm.proyecto.fotos=jsonFotos;vm.proyecto.fecha_fin=new Date(vm.proyecto.fecha_fin.getMonth()+1+"/"+vm.proyecto.fecha_fin.getDate()+"/"+vm.proyecto.fecha_fin.getFullYear());vm.proyecto.status_cambio=1;vm.proyecto.usuario_id=vm.user.data.id;ProyectService.createCambio(vm.proyecto,function(data){UploadVars.uploadsList=[];vm.proyecto={proyecto_id:-1};vm.showJustificaciones=false})}function createProyecto(){var conErrores=false;vm.proyecto.fotos=[{main:0,nombre:vm.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:vm.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:vm.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:vm.foto_04,carpeta:"",proyecto_id:-1}];vm.proyecto.categorias=[{categoria_id:vm.proyecto_categoria}];vm.proyecto.fecha_fin=new Date(vm.proyecto.fecha_fin.getMonth()+1+"/"+vm.proyecto.fecha_fin.getDate()+"/"+vm.proyecto.fecha_fin.getFullYear());vm.proyecto.usuario_id=vm.user.data.id;if(vm.proyecto.proyecto_id==-1){ProyectService.create(vm.proyecto,function(data){ProyectService.get(function(data){vm.proyectos=data;UploadVars.uploadsList=[];vm.proyecto={proyecto_id:-1}})})}else{vm.showJustificaciones=true}}function updateFotoProyecto(filelist,id,sub_folder){UploadService.addImages(filelist,id,sub_folder,function(data){for(var i=0;i<UploadVars.uploadsList.length;i++){if(UploadVars.uploadsList[i].id==1){vm.foto_01=UploadVars.uploadsList[i].file.name}if(UploadVars.uploadsList[i].id==2){vm.foto_02=UploadVars.uploadsList[i].file.name}if(UploadVars.uploadsList[i].id==3){vm.foto_03=UploadVars.uploadsList[i].file.name}if(UploadVars.uploadsList[i].id==4){vm.foto_04=UploadVars.uploadsList[i].file.name}}$scope.$apply()})}function selectCambio(cambio){vm.proyecto_modificado=cambio;ProyectService.getByParams("proyecto_id",""+cambio.proyecto_id,""+true,function(data){vm.proyecto_original=data[0]})}function confirmarCambio(){vm.proyecto_modificado.status_cambio=2;ProyectService.updateCambio(vm.proyecto_modificado,function(data){if(data!=-1){ProyectService.update(vm.proyecto_modificado,function(data){ProyectService.getCambios(function(data){vm.cambios=data;vm.proyecto_original={};vm.proyecto_modificado={}})})}})}function negarCambio(){vm.proyecto_modificado.status_cambio=0;ProyectService.updateCambio(vm.proyecto_modificado,function(data){ProyectService.getCambios(function(data){vm.cambios=data;vm.proyecto_original={};vm.proyecto_modificado={}})})}function removeCategoria(){var r=confirm("Realmente desea eliminar la categoria? Esta operaciÃ³n no tiene deshacer.");if(r){CategoryService.remove(vm.id,function(data){})}}function modificarCategoria(categoria){vm.categoria=angular.copy(categoria);var elem=angular.element(document.querySelector("#nombre-categoria"));elem[0].focus()}function saveCategoria(){if(vm.categoria.parent_id==undefined){vm.categoria.parent_id=-1}if(vm.categoria.categoria_id!=-1){CategoryService.update(vm.categoria,function(data){if(data=="true"){CategoryService.get(function(data){vm.categorias=data});CategoryService.getByParams("parent_id","-1","true",function(data){vm.padres=data})}else{}})}else{CategoryService.create(vm.categoria,function(data){CategoryService.get(function(data){vm.categorias=data});CategoryService.getByParams("parent_id","-1","true",function(data){vm.padres=data})})}vm.categoria={};vm.categoria.categoria_id=-1}function aprobarDonacion(donacion){if(!vm.user){$location.path("/ingreso");return}donacion.status=1;DonationService.update(donacion,function(data){DonationService.get(-1,function(data){console.log(data);vm.donaciones=data})})}}function AdministracionService(){this.screen="administracion/datos.html"}})();