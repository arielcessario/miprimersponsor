(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(T,e,i,L,q,y,m,r,z,F,l,g,R,J,H){var s=this;s.screen=l.screen;s.usuarios=[];s.usuario={usuario_id:-1};s.user=T.getFromToken();s.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};s.proyectos=[];s.showJustificaciones=false;s.foto_01="";s.foto_02="";s.foto_03="";s.foto_04="";s.donaciones_entregadas=[];s.donaciones_obtenidas=[];s.cambios=[];s.padres=[];s.categoria={};s.proyecto_categoria=-1;s.donaciones=[];s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.validation=true;s.proyecto_original={proyecto_id:-1};s.proyecto_modificado={proyecto_id:-1};s.modificarUsuario=A;s.resetUsuario=k;s.saveUsuario=n;s.removeUsuario=P;s.updateUsuario=j;s.modificarProyecto=f;s.resetProyecto=G;s.confirmarProyecto=w;s.removeProyecto=u;s.createProyecto=K;s.updateEnSlider=B;s.createCambio=M;s.updateFotoProyecto=I;s.selectCambio=E;s.confirmarCambio=x;s.negarCambio=N;s.modificarCategoria=t;s.saveCategoria=O;s.removeCategoria=D;s.resetCategoria=C;s.aprobarDonacion=h;s.cancelarDonacion=o;s.subirComprobante=S;if(T.getFromToken()==false){L.path("/ingreso")}m.$watch("administracionCtrl.screen",function(V,U){if(V=="administracion/datos.html"){if(s.user.data!=undefined&&s.user.data.rol=="0"){T.getByParams("marcado","0","true",function(W){s.usuarios=W;s.usuario.rol_id="1"})}else{s.usuario=T.getLogged()}}if(V=="administracion/patrocinadores.html"||V=="administracion/aportes.html"){z.clearCache=true;s.donaciones_entregadas=[];s.donaciones_obtenidas=[];r.get(s.user.data.id,function(X){for(var W=0;W<X.length;W++){if(X[W].donador_id==s.user.data.id){s.donaciones_entregadas.push(X[W])}else{s.donaciones_obtenidas.push(X[W])}}})}if(V=="administracion/proyectos.html"){F.get(function(W){s.categorias=W;s.proyecto_categoria=W[0].categoria_id});if(s.user.data.rol==0){H.activos=false;H.clearCache=true;i.get(function(W){if(W.length>0){p(W)}})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(W){if(W.length>0){p(W)}})}}if(V=="administracion/cambios.html"){i.getCambios(function(X){console.log(X);for(var W=0;W<X.length;W++){if(X[W].fotos!="[]"){X[W].fotos=JSON.parse(X[W].fotos)}}s.cambios=X})}if(V=="administracion/categorias.html"){F.get(function(W){s.categorias=W;s.categoria.categoria_id=-1});F.getByParams("parent_id","-1","true",function(W){s.padres=W})}if(V=="administracion/donaciones.html"){r.get(-1,function(W){s.donaciones=W})}});function v(){s.validation=false;J(function(){s.validation=true},1)}function p(V){for(var U=0;U<V.length;U++){V[U].costo_inicial=parseFloat(V[U].costo_inicial);V[U].total_donado=parseFloat(V[U].total_donado);V[U].fecha_inicio=new Date(V[U].fecha_inicio);V[U].fecha_fin=new Date(V[U].fecha_fin);if(V[U].status==1){V[U].statusTexto="Activo"}if(V[U].status==0){V[U].statusTexto="Baja"}if(V[U].status==2){V[U].statusTexto="Terminado"}if(V[U].status==3){V[U].statusTexto="Dinero Transferido"}if(V[U].status==4){V[U].statusTexto="Pendiente de Aprobación"}V[U].status=""+V[U].status}s.proyectos=V}function A(V){g.broadcast();s.usuario=angular.copy(V);s.usuario.rol_id=""+s.usuario.rol_id;s.usuario.calle=""+s.usuario.direcciones[0].calle;var U=angular.element(document.querySelector("#nombre"))}function k(){s.usuario={usuario_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function n(){}function P(){if(s.usuario.usuario_id==-1){return}var U=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!U){return}s.usuario.marcado=1;T.update(s.usuario,function(V){T.getByParams("marcado","0","true",function(W){s.usuarios=W;k();v()})})}function j(){if(s.user.data.rol!=0){s.usuario.rol_id=s.user.data.rol}if(s.usuario.usuario_id==-1){return}T.update(s.usuario,function(U){if(s.user.data.rol==0){T.getByParams("marcado","0","true",function(V){s.usuarios=V;k();v();e.showMessage("success","Datos Guardados con Éxito")})}else{s.usuario.password="";T.setLogged(s.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(V){g.broadcast();s.proyecto=angular.copy(V);s.proyecto.en_slider=""+s.proyecto.en_slider;s.proyecto_categoria=s.proyecto.categoria_id;var U=angular.element(document.querySelector("#nombre"));s.foto_01=(s.proyecto.fotos[0]!=undefined)?s.proyecto.fotos[0].nombre:"no_image.png";s.foto_02=(s.proyecto.fotos[1]!=undefined)?s.proyecto.fotos[1].nombre:"no_image.png";s.foto_03=(s.proyecto.fotos[2]!=undefined)?s.proyecto.fotos[2].nombre:"no_image.png";s.foto_04=(s.proyecto.fotos[3]!=undefined)?s.proyecto.fotos[3].nombre:"no_image.png";U[0].focus();s.proyecto_categoria=s.proyecto.categoria_id}function G(){s.proyecto={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"1",status:-1};s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.showJustificaciones=false}function u(){if(s.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var U=confirm("La eleminación de un proyecto debe ser aprobada por un administrador. Desea continuar?");if(!U){return}if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;s.proyecto.status=0;return}}function w(){if(s.proyecto.proyecto_id==-1){return}s.proyecto.status=1;s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];i.update(s.proyecto,function(U){H.clearCache=true;i.get(function(V){if(V.length>0){p(V);G();R.sendMail(window.mailAdmin,[{mail:s.user.data.mail}],"MPE","CONFIRMACIÓN DE PROYECTO - Proyecto "+s.proyecto.nombre,"Se aprobó el proyecto",function(W){console.log(W)})}})})}function M(){if(s.proyecto.justificacion==undefined||s.proyecto.justificacion.replace(" ","").length==""){e.showMessage("error","Debe ingresar una justificación para el cambio");return}var V="[";for(var U=0;U<s.proyecto.fotos.length;U++){V=V+'{"main":"0","nombre":"'+s.proyecto.fotos[U].nombre+'","folder":"","proyecto_id":"'+s.proyecto.proyecto_id+'"},'}V=V.substring(0,V.length-1);V=V+"]";s.proyecto.fotos=V;s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.status_cambio=1;s.proyecto.usuario_id=s.user.data.id;s.proyecto.categorias=s.proyecto_categoria;i.createCambio(s.proyecto,function(W){y.uploadsList=[];s.showJustificaciones=false;v();R.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(X){console.log(X)});s.proyecto={proyecto_id:-1}})}function K(){s.proyecto.fotos=[{main:0,nombre:s.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_04,carpeta:"",proyecto_id:-1}];s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.usuario_id=s.user.data.id;if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;return}s.proyecto.status=4;s.proyecto.en_slider=0;i.create(s.proyecto,function(U){e.showMessage("success","El proyecto ha sido creado, por favor aguarde la aprobación del administrador. Gracias.");R.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE NUEVO PROYECTO - Proyecto "+s.proyecto.nombre,"Existe un nuevo proyecto para aprobar",function(V){console.log(V)});if(s.user.data.rol=="0"){i.get(function(V){p(V);y.uploadsList=[];G();v()})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(V){if(V.length>0){p(V)}G();v()})}})}function B(V,X){var W=0;for(var U=0;U<s.proyectos.length;U++){if(s.proyectos[U].en_slider==1&&s.proyectos[U].statusTexto=="Activo"){W=W+1}}if(W>3&&V==1){e.showMessage("error","Solo se pueden asignar hasta 4 proyectos en el slider.");return}X.en_slider=V;i.update(X,function(Y){if(s.user.data.rol=="0"){i.get(function(Z){p(Z);y.uploadsList=[];G();v()})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(Z){if(Z.length>0){p(Z)}G();v()})}})}function I(U,W,V){q.addImages(U,W,V,function(Y){for(var X=0;X<y.uploadsList.length;X++){if(y.uploadsList[X].id==1){s.foto_01=y.uploadsList[X].file.name}if(y.uploadsList[X].id==2){s.foto_02=y.uploadsList[X].file.name}if(y.uploadsList[X].id==3){s.foto_03=y.uploadsList[X].file.name}if(y.uploadsList[X].id==4){s.foto_04=y.uploadsList[X].file.name}}m.$apply()})}function E(U){s.proyecto_modificado=U;if(U.status==0){s.proyecto_modificado.status_texto="Baja"}else{if(U.status==1){s.proyecto_modificado.status_texto="Activo"}else{if(U.status==2){s.proyecto_modificado.status_texto="Terminado"}else{if(U.status==3){s.proyecto_modificado.status_texto="Dinero Transferido"}else{if(U.status==4){s.proyecto_modificado.status_texto="Pendiente de Aprobación"}}}}}s.proyecto_modificado.fecha_fin_texto=s.proyecto_modificado.fecha_fin.substr(8,2)+"-"+s.proyecto_modificado.fecha_fin.substr(5,2)+"-"+s.proyecto_modificado.fecha_fin.substr(0,4);i.getByParams("proyecto_id",""+U.proyecto_id,""+true,function(V){s.proyecto_original=V[0];console.log(s.proyecto_original);if(s.proyecto_original.status==0){s.proyecto_original.status_texto="Baja"}else{if(s.proyecto_original.status==1){s.proyecto_original.status_texto="Activo"}else{if(s.proyecto_original.status==2){s.proyecto_original.status_texto="Terminado"}else{if(s.proyecto_original.status==3){s.proyecto_original.status_texto="Dinero Transferido"}else{if(s.proyecto_original.status==4){s.proyecto_original.status_texto="Pendiente de Aprobación"}}}}}s.proyecto_original.fecha_fin_texto=s.proyecto_original.fecha_fin.substr(8,2)+"-"+s.proyecto_original.fecha_fin.substr(5,2)+"-"+s.proyecto_original.fecha_fin.substr(0,4)})}function x(){if(s.proyecto_original.proyecto_id==-1||s.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=2;s.proyecto_modificado.aprobador_id=s.user.data.id;s.proyecto_modificado.categorias=[{categoria_id:s.proyecto_modificado.categorias}];console.log(s.proyecto_modificado);i.updateCambio(s.proyecto_modificado,function(U){if(U!=-1){i.update(s.proyecto_modificado,function(V){i.getCambios(function(W){R.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido aprobado",function(X){console.log(X)});s.cambios=W;Q();v()})})}})}function N(){if(s.proyecto_original.proyecto_id==-1||s.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=0;s.proyecto_modificado.aprobador_id=s.user.data.id;i.updateCambio(s.proyecto_modificado,function(U){i.getCambios(function(V){R.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido cancelado",function(W){console.log(W)});s.cambios=V;Q();v()})})}function D(){console.log(s.categoria);if(s.categoria.categoria_id==-1){e.showMessage("error","No ha seleccionado una categoría.");return}var U=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(U){F.update(s.categoria,function(V){})}}function Q(){s.proyecto_original={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};s.proyecto_modificado={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"})}function t(V){s.categoria=angular.copy(V);var U=angular.element(document.querySelector("#nombre-categoria"));U[0].focus()}function O(){if(s.categoria.parent_id==undefined){s.categoria.parent_id=-1}if(s.categoria.nombre==undefined||s.categoria.nombre.replace(" ","").length==0){e.showMessage("error","El nombre no puede ser vacío");return}if(s.categoria.categoria_id!=-1){F.update(s.categoria,function(U){if(U=="true"){F.get(function(V){s.categorias=V;v()});F.getByParams("parent_id","-1","true",function(V){s.padres=V;v()})}else{}})}else{F.create(s.categoria,function(U){F.get(function(V){s.categorias=V;v()});F.getByParams("parent_id","-1","true",function(V){s.padres=V;v()})})}s.categoria={};s.categoria.categoria_id=-1}function h(U){if(!s.user){L.path("/ingreso");return}U.status=1;r.update(U,function(V){T.getByParams("usuario_id",""+U.donador_id,"true",function(W){R.sendMail(window.mailAdmin,[{mail:W[0].mail}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(Y,X){console.log(Y);console.log(X)})});r.get(-1,function(W){s.donaciones=W;H.clearCache=true;i.get(function(X){})})})}function o(U){if(!s.user){L.path("/ingreso");return}U.status=2;r.update(U,function(V){T.getByParams("usuario_id",""+U.donador_id,"true",function(W){R.sendMail(window.mailAdmin,[{mail:W[0].mail}],"Ariel","PRUEBA","PRUEBA DE CANCELACIÓN DE DONACIÓN",function(Y,X){console.log(Y);console.log(X)})});r.get(-1,function(W){s.donaciones=W;H.clearCache=true;i.get(function(X){})})})}function C(){s.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function S(U){q.uploadImages(U.item(0),"",function(V){i.confirmarDeposito(s.proyecto.proyecto_id,U.item(0).name,function(W){console.log(W);i.get(function(X){s.proyectos=X})})})}}function d(){this.screen="administracion/datos.html"}})();