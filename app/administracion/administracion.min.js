(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(S,e,i,K,q,y,m,r,z,E,l,g,P,I,G){var s=this;s.screen=l.screen;s.usuarios=[];s.usuario={usuario_id:-1};s.user=S.getFromToken();s.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};s.proyectos=[];s.showJustificaciones=false;s.foto_01="";s.foto_02="";s.foto_03="";s.foto_04="";s.donaciones_entregadas=[];s.donaciones_obtenidas=[];s.cambios=[];s.padres=[];s.categoria={};s.proyecto_categoria=-1;s.donaciones=[];s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.validation=true;s.proyecto_original={proyecto_id:-1};s.proyecto_modificado={proyecto_id:-1};s.modificarUsuario=A;s.resetUsuario=k;s.saveUsuario=n;s.removeUsuario=O;s.updateUsuario=j;s.modificarProyecto=f;s.resetProyecto=F;s.confirmarProyecto=w;s.removeProyecto=u;s.createProyecto=J;s.createCambio=L;s.updateFotoProyecto=H;s.selectCambio=D;s.confirmarCambio=x;s.negarCambio=M;s.modificarCategoria=t;s.saveCategoria=N;s.removeCategoria=C;s.resetCategoria=B;s.aprobarDonacion=h;s.cancelarDonacion=o;s.subirComprobante=R;if(S.getFromToken()==false){K.path("/ingreso")}m.$watch("administracionCtrl.screen",function(U,T){if(U=="administracion/datos.html"){if(s.user.data!=undefined&&s.user.data.rol=="0"){S.getByParams("marcado","0","true",function(V){s.usuarios=V;s.usuario.rol_id="1"})}else{s.usuario=S.getLogged()}}if(U=="administracion/patrocinadores.html"||U=="administracion/aportes.html"){z.clearCache=true;s.donaciones_entregadas=[];s.donaciones_obtenidas=[];r.get(s.user.data.id,function(W){for(var V=0;V<W.length;V++){if(W[V].donador_id==s.user.data.id){s.donaciones_entregadas.push(W[V])}else{s.donaciones_obtenidas.push(W[V])}}})}if(U=="administracion/proyectos.html"){E.get(function(V){s.categorias=V;s.proyecto_categoria=V[0].categoria_id});if(s.user.data.rol==0){G.activos=false;G.clearCache=true;i.get(function(V){if(V.length>0){p(V)}})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(V){if(V.length>0){p(V)}})}}if(U=="administracion/cambios.html"){i.getCambios(function(W){console.log(W);for(var V=0;V<W.length;V++){if(W[V].fotos!="[]"){W[V].fotos=JSON.parse(W[V].fotos)}}s.cambios=W})}if(U=="administracion/categorias.html"){E.get(function(V){s.categorias=V;s.categoria.categoria_id=-1});E.getByParams("parent_id","-1","true",function(V){s.padres=V})}if(U=="administracion/donaciones.html"){r.get(-1,function(V){s.donaciones=V})}});function v(){s.validation=false;I(function(){s.validation=true},1)}function p(U){for(var T=0;T<U.length;T++){U[T].costo_inicial=parseFloat(U[T].costo_inicial);U[T].total_donado=parseFloat(U[T].total_donado);U[T].fecha_inicio=new Date(U[T].fecha_inicio);U[T].fecha_fin=new Date(U[T].fecha_fin);if(U[T].status==1){U[T].statusTexto="Activo"}if(U[T].status==0){U[T].statusTexto="Baja"}if(U[T].status==2){U[T].statusTexto="Terminado"}if(U[T].status==3){U[T].statusTexto="Dinero Transferido"}if(U[T].status==4){U[T].statusTexto="Pendiente de Aprobación"}U[T].status=""+U[T].status}s.proyectos=U}function A(U){g.broadcast();s.usuario=angular.copy(U);s.usuario.rol_id=""+s.usuario.rol_id;s.usuario.calle=""+s.usuario.direcciones[0].calle;var T=angular.element(document.querySelector("#nombre"))}function k(){s.usuario={usuario_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function n(){}function O(){if(s.usuario.usuario_id==-1){return}var T=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!T){return}s.usuario.marcado=1;S.update(s.usuario,function(U){S.getByParams("marcado","0","true",function(V){s.usuarios=V;k();v()})})}function j(){if(s.user.data.rol!=0){s.usuario.rol_id=s.user.data.rol}if(s.usuario.usuario_id==-1){return}S.update(s.usuario,function(T){if(s.user.data.rol==0){S.getByParams("marcado","0","true",function(U){s.usuarios=U;k();v();e.showMessage("success","Datos Guardados con Éxito")})}else{s.usuario.password="";S.setLogged(s.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(U){g.broadcast();s.proyecto=angular.copy(U);s.proyecto.en_slider=""+s.proyecto.en_slider;s.proyecto_categoria=s.proyecto.categoria_id;var T=angular.element(document.querySelector("#nombre"));s.foto_01=(s.proyecto.fotos[0]!=undefined)?s.proyecto.fotos[0].nombre:"no_image.png";s.foto_02=(s.proyecto.fotos[1]!=undefined)?s.proyecto.fotos[1].nombre:"no_image.png";s.foto_03=(s.proyecto.fotos[2]!=undefined)?s.proyecto.fotos[2].nombre:"no_image.png";s.foto_04=(s.proyecto.fotos[3]!=undefined)?s.proyecto.fotos[3].nombre:"no_image.png";T[0].focus();s.proyecto_categoria=s.proyecto.categoria_id}function F(){s.proyecto={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"1",status:-1};s.foto_01="no_image.png";s.foto_02="no_image.png";s.foto_03="no_image.png";s.foto_04="no_image.png";s.showJustificaciones=false}function u(){if(s.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var T=confirm("La eleminación de un proyecto debe ser aprobada por un administrador. Desea continuar?");if(!T){return}if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;s.proyecto.status=0;return}}function w(){if(s.proyecto.proyecto_id==-1){return}s.proyecto.status=1;s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];i.update(s.proyecto,function(T){G.clearCache=true;i.get(function(U){if(U.length>0){p(U);F();P.sendMail(window.mailAdmin,[{mail:s.user.data.mail}],"MPE","CONFIRMACIÓN DE PROYECTO - Proyecto "+s.proyecto.nombre,"Se aprobó el proyecto",function(V){console.log(V)})}})})}function L(){if(s.proyecto.justificacion==undefined||s.proyecto.justificacion.replace(" ","").length==""){e.showMessage("error","Debe ingresar una justificación para el cambio");return}var U="[";for(var T=0;T<s.proyecto.fotos.length;T++){U=U+'{"main":"0","nombre":"'+s.proyecto.fotos[T].nombre+'","folder":"","proyecto_id":"'+s.proyecto.proyecto_id+'"},'}U=U.substring(0,U.length-1);U=U+"]";s.proyecto.fotos=U;s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.status_cambio=1;s.proyecto.usuario_id=s.user.data.id;s.proyecto.categorias=s.proyecto_categoria;i.createCambio(s.proyecto,function(V){y.uploadsList=[];s.showJustificaciones=false;v();P.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(W){console.log(W)});s.proyecto={proyecto_id:-1}})}function J(){s.proyecto.fotos=[{main:0,nombre:s.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:s.foto_04,carpeta:"",proyecto_id:-1}];s.proyecto.categorias=[{categoria_id:s.proyecto_categoria}];s.proyecto.fecha_fin=new Date((s.proyecto.fecha_fin.getMonth()+1)+"/"+(s.proyecto.fecha_fin.getDate())+"/"+s.proyecto.fecha_fin.getFullYear());s.proyecto.usuario_id=s.user.data.id;if(s.proyecto.proyecto_id!=-1){s.showJustificaciones=true;return}s.proyecto.status=4;i.create(s.proyecto,function(T){e.showMessage("success","El proyecto ha sido creado, por favor aguarde la aprobación del administrador. Gracias.");P.sendMail(s.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE NUEVO PROYECTO - Proyecto "+s.proyecto.nombre,"Existe un nuevo proyecto para aprobar",function(U){console.log(U)});if(s.user.data.rol=="0"){i.get(function(U){p(U);y.uploadsList=[];F();v()})}else{i.getByParams("usuario_id",""+s.user.data.id,"true",function(U){if(U.length>0){p(U)}F();v()})}})}function H(T,V,U){q.addImages(T,V,U,function(X){for(var W=0;W<y.uploadsList.length;W++){if(y.uploadsList[W].id==1){s.foto_01=y.uploadsList[W].file.name}if(y.uploadsList[W].id==2){s.foto_02=y.uploadsList[W].file.name}if(y.uploadsList[W].id==3){s.foto_03=y.uploadsList[W].file.name}if(y.uploadsList[W].id==4){s.foto_04=y.uploadsList[W].file.name}}m.$apply()})}function D(T){s.proyecto_modificado=T;i.getByParams("proyecto_id",""+T.proyecto_id,""+true,function(U){s.proyecto_original=U[0]})}function x(){if(s.proyecto_original.proyecto_id==-1||s.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=2;s.proyecto_modificado.aprobador_id=s.user.data.id;s.proyecto_modificado.categorias=[{categoria_id:s.proyecto_modificado.categorias}];console.log(s.proyecto_modificado);i.updateCambio(s.proyecto_modificado,function(T){if(T!=-1){i.update(s.proyecto_modificado,function(U){i.getCambios(function(V){P.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido aprobado",function(W){console.log(W)});s.cambios=V;Q();v()})})}})}function M(){if(s.proyecto_original.proyecto_id==-1||s.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(s.proyecto_modificado.respuesta==undefined||s.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}s.proyecto_modificado.status_cambio=0;s.proyecto_modificado.aprobador_id=s.user.data.id;i.updateCambio(s.proyecto_modificado,function(T){i.getCambios(function(U){P.sendMail(s.user.data.mail,[{mail:s.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+s.proyecto.nombre,"Su cambio ha sido cancelado",function(V){console.log(V)});s.cambios=U;Q();v()})})}function C(){console.log(s.categoria);if(s.categoria.categoria_id==-1){e.showMessage("error","No ha seleccionado una categoría.");return}var T=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(T){E.update(s.categoria,function(U){})}}function Q(){s.proyecto_original={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};s.proyecto_modificado={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_original.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"});s.proyecto_modificado.fotos.push({nombre:"no_image.png"})}function t(U){s.categoria=angular.copy(U);var T=angular.element(document.querySelector("#nombre-categoria"));T[0].focus()}function N(){if(s.categoria.parent_id==undefined){s.categoria.parent_id=-1}if(s.categoria.nombre==undefined||s.categoria.nombre.replace(" ","").length==0){e.showMessage("error","El nombre no puede ser vacío");return}if(s.categoria.categoria_id!=-1){E.update(s.categoria,function(T){if(T=="true"){E.get(function(U){s.categorias=U;v()});E.getByParams("parent_id","-1","true",function(U){s.padres=U;v()})}else{}})}else{E.create(s.categoria,function(T){E.get(function(U){s.categorias=U;v()});E.getByParams("parent_id","-1","true",function(U){s.padres=U;v()})})}s.categoria={};s.categoria.categoria_id=-1}function h(T){if(!s.user){K.path("/ingreso");return}T.status=1;r.update(T,function(U){S.getByParams("usuario_id",""+T.donador_id,"true",function(V){P.sendMail(window.mailAdmin,[{mail:V[0].mail}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(X,W){console.log(X);console.log(W)})});r.get(-1,function(V){s.donaciones=V;G.clearCache=true;i.get(function(W){})})})}function o(T){if(!s.user){K.path("/ingreso");return}T.status=2;r.update(T,function(U){S.getByParams("usuario_id",""+T.donador_id,"true",function(V){P.sendMail(window.mailAdmin,[{mail:V[0].mail}],"Ariel","PRUEBA","PRUEBA DE CANCELACIÓN DE DONACIÓN",function(X,W){console.log(X);console.log(W)})});r.get(-1,function(V){s.donaciones=V;G.clearCache=true;i.get(function(W){})})})}function B(){s.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function R(T){q.uploadImages(T.item(0),"",function(U){i.confirmarDeposito(s.proyecto.proyecto_id,T.item(0).name,function(V){console.log(V);i.get(function(W){s.proyectos=W})})})}}function d(){this.screen="administracion/datos.html"}})();