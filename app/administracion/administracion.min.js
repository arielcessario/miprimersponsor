(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(U,e,i,M,r,z,n,s,A,G,l,g,S,K,I){var t=this;t.screen=l.screen;t.usuarios=[];t.usuario={usuario_id:-1};t.user=U.getFromToken();t.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};t.proyectos=[];t.showJustificaciones=false;t.foto_01="";t.foto_02="";t.foto_03="";t.foto_04="";t.donaciones_entregadas=[];t.donaciones_obtenidas=[];t.cambios=[];t.padres=[];t.categoria={};t.proyecto_categoria=-1;t.donaciones=[];t.foto_01="no_image.png";t.foto_02="no_image.png";t.foto_03="no_image.png";t.foto_04="no_image.png";t.validation=true;t.limit=10;t.start=0;t.proyecto_original={proyecto_id:-1};t.proyecto_modificado={proyecto_id:-1};t.modificarUsuario=B;t.resetUsuario=k;t.saveUsuario=o;t.removeUsuario=Q;t.updateUsuario=j;t.modificarProyecto=f;t.resetProyecto=H;t.confirmarProyecto=x;t.removeProyecto=v;t.createProyecto=L;t.updateEnSlider=C;t.createCambio=N;t.updateFotoProyecto=J;t.putInSlider=m;t.selectCambio=F;t.confirmarCambio=y;t.negarCambio=O;t.modificarCategoria=u;t.saveCategoria=P;t.removeCategoria=E;t.resetCategoria=D;t.aprobarDonacion=h;t.cancelarDonacion=p;t.subirComprobante=T;if(U.getFromToken()==false){M.path("/ingreso")}n.$watch("administracionCtrl.screen",function(W,V){if(W=="administracion/datos.html"){if(t.user.data!=undefined&&t.user.data.rol=="0"){U.getByParams("marcado","0","true",function(X){t.usuarios=X;t.usuario.rol_id="1"})}else{t.usuario=U.getLogged()}}if(W=="administracion/patrocinadores.html"||W=="administracion/aportes.html"){A.clearCache=true;t.donaciones_entregadas=[];t.donaciones_obtenidas=[];s.get(t.user.data.id,function(Y){for(var X=0;X<Y.length;X++){if(Y[X].donador_id==t.user.data.id){t.donaciones_entregadas.push(Y[X])}else{t.donaciones_obtenidas.push(Y[X])}}})}if(W=="administracion/proyectos.html"){G.get(function(X){t.categorias=X;t.proyecto_categoria=X[0].categoria_id});if(t.user.data.rol==0){I.activos=false;I.clearCache=true;i.get(function(X){if(X.length>0){q(X)}})}else{i.getByParams("usuario_id",""+t.user.data.id,"true",function(X){if(X.length>0){q(X)}})}}if(W=="administracion/cambios.html"){i.getCambios(function(Y){console.log(Y);for(var X=0;X<Y.length;X++){if(Y[X].fotos!="[]"){Y[X].fotos=JSON.parse(Y[X].fotos)}}t.cambios=Y})}if(W=="administracion/categorias.html"){G.get(function(X){t.categorias=X;t.categoria.categoria_id=-1});G.getByParams("parent_id","-1","true",function(X){t.padres=X})}if(W=="administracion/donaciones.html"){s.get(-1,function(X){t.donaciones=X})}});function w(){t.validation=false;K(function(){t.validation=true},1)}function q(W){for(var V=0;V<W.length;V++){W[V].costo_inicial=parseFloat(W[V].costo_inicial);W[V].total_donado=parseFloat(W[V].total_donado);W[V].fecha_inicio=new Date(W[V].fecha_inicio);W[V].fecha_fin=new Date(W[V].fecha_fin);if(W[V].status==1){W[V].statusTexto="Activo"}if(W[V].status==0){W[V].statusTexto="Baja"}if(W[V].status==2){W[V].statusTexto="Terminado"}if(W[V].status==3){W[V].statusTexto="Dinero Transferido"}if(W[V].status==4){W[V].statusTexto="Pendiente de Aprobación"}W[V].status=""+W[V].status}t.proyectos=W}function B(W){g.broadcast();t.usuario=angular.copy(W);t.usuario.rol_id=""+t.usuario.rol_id;t.usuario.calle=""+t.usuario.direcciones[0].calle;var V=angular.element(document.querySelector("#nombre"))}function k(){t.usuario={usuario_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function o(){}function Q(){if(t.usuario.usuario_id==-1){return}var V=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!V){return}t.usuario.marcado=1;U.update(t.usuario,function(W){U.getByParams("marcado","0","true",function(X){t.usuarios=X;k();w()})})}function j(){if(t.user.data.rol!=0){t.usuario.rol_id=t.user.data.rol}if(t.usuario.usuario_id==-1){return}U.update(t.usuario,function(V){if(t.user.data.rol==0){U.getByParams("marcado","0","true",function(W){t.usuarios=W;k();w();e.showMessage("success","Datos Guardados con Éxito")})}else{t.usuario.password="";U.setLogged(t.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(W){g.broadcast();t.proyecto=angular.copy(W);t.proyecto.en_slider=""+t.proyecto.en_slider;t.proyecto_categoria=t.proyecto.categoria_id;var V=angular.element(document.querySelector("#nombre"));t.foto_01=(t.proyecto.fotos[0]!=undefined)?t.proyecto.fotos[0].nombre:"no_image.png";t.foto_02=(t.proyecto.fotos[1]!=undefined)?t.proyecto.fotos[1].nombre:"no_image.png";t.foto_03=(t.proyecto.fotos[2]!=undefined)?t.proyecto.fotos[2].nombre:"no_image.png";t.foto_04=(t.proyecto.fotos[3]!=undefined)?t.proyecto.fotos[3].nombre:"no_image.png";V[0].focus();t.proyecto_categoria=t.proyecto.categoria_id}function H(){t.proyecto={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"1",status:-1};t.foto_01="no_image.png";t.foto_02="no_image.png";t.foto_03="no_image.png";t.foto_04="no_image.png";t.showJustificaciones=false}function v(){if(t.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var V=confirm("La eleminación de un proyecto debe ser aprobada por un administrador. Desea continuar?");if(!V){return}if(t.proyecto.proyecto_id!=-1){t.showJustificaciones=true;t.proyecto.status=0;return}}function x(){if(t.proyecto.proyecto_id==-1){return}t.proyecto.status=1;t.proyecto.categorias=[{categoria_id:t.proyecto_categoria}];i.update(t.proyecto,function(V){I.clearCache=true;i.get(function(W){if(W.length>0){q(W);H();S.sendMail(window.mailAdmin,[{mail:t.user.data.mail}],"MPE","CONFIRMACIÓN DE PROYECTO - Proyecto "+t.proyecto.nombre,"Se aprobó el proyecto",function(X){console.log(X)})}})})}function m(V){if(V.en_slider==1){V.en_slider=0}else{V.en_slider=1}i.update(V,function(W){I.clearCache=true;i.get(function(X){if(X.length>0){q(X);H()}})})}function N(){if(t.proyecto.justificacion==undefined||t.proyecto.justificacion.replace(" ","").length==""){e.showMessage("error","Debe ingresar una justificación para el cambio");return}var W="[";for(var V=0;V<t.proyecto.fotos.length;V++){W=W+'{"main":"0","nombre":"'+t.proyecto.fotos[V].nombre+'","folder":"","proyecto_id":"'+t.proyecto.proyecto_id+'"},'}W=W.substring(0,W.length-1);W=W+"]";t.proyecto.fotos=W;t.proyecto.fecha_fin=new Date((t.proyecto.fecha_fin.getMonth()+1)+"/"+(t.proyecto.fecha_fin.getDate())+"/"+t.proyecto.fecha_fin.getFullYear());t.proyecto.status_cambio=1;t.proyecto.usuario_id=t.user.data.id;t.proyecto.categorias=t.proyecto_categoria;i.createCambio(t.proyecto,function(X){z.uploadsList=[];t.showJustificaciones=false;w();S.sendMail(t.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE CAMBIO - Proyecto "+t.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(Y){console.log(Y)});t.proyecto={proyecto_id:-1}})}function L(){t.proyecto.fotos=[{main:0,nombre:t.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:t.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:t.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:t.foto_04,carpeta:"",proyecto_id:-1}];t.proyecto.categorias=[{categoria_id:t.proyecto_categoria}];t.proyecto.fecha_fin=new Date((t.proyecto.fecha_fin.getMonth()+1)+"/"+(t.proyecto.fecha_fin.getDate())+"/"+t.proyecto.fecha_fin.getFullYear());t.proyecto.usuario_id=t.user.data.id;if(t.proyecto.proyecto_id!=-1){t.showJustificaciones=true;return}t.proyecto.status=4;t.proyecto.en_slider=0;i.create(t.proyecto,function(V){e.showMessage("success","El proyecto ha sido creado, por favor aguarde la aprobación del administrador. Gracias.");S.sendMail(t.user.data.mail,window.mailAdmins,"MPE","CREACIÓN DE NUEVO PROYECTO - Proyecto "+t.proyecto.nombre,"Existe un nuevo proyecto para aprobar",function(W){console.log(W)});if(t.user.data.rol=="0"){i.get(function(W){q(W);z.uploadsList=[];H();w()})}else{i.getByParams("usuario_id",""+t.user.data.id,"true",function(W){if(W.length>0){q(W)}H();w()})}})}function C(W,Y){var X=0;for(var V=0;V<t.proyectos.length;V++){if(t.proyectos[V].en_slider==1&&t.proyectos[V].statusTexto=="Activo"){X=X+1}}if(X>3&&W==1){e.showMessage("error","Solo se pueden asignar hasta 4 proyectos en el slider.");return}Y.en_slider=W;i.update(Y,function(Z){if(t.user.data.rol=="0"){i.get(function(aa){q(aa);z.uploadsList=[];H();w()})}else{i.getByParams("usuario_id",""+t.user.data.id,"true",function(aa){if(aa.length>0){q(aa)}H();w()})}})}function J(V,X,W){r.addImages(V,X,W,function(Z){for(var Y=0;Y<z.uploadsList.length;Y++){if(z.uploadsList[Y].id==1){t.foto_01=z.uploadsList[Y].file.name}if(z.uploadsList[Y].id==2){t.foto_02=z.uploadsList[Y].file.name}if(z.uploadsList[Y].id==3){t.foto_03=z.uploadsList[Y].file.name}if(z.uploadsList[Y].id==4){t.foto_04=z.uploadsList[Y].file.name}}n.$apply()})}function F(V){t.proyecto_modificado=V;if(V.status==0){t.proyecto_modificado.status_texto="Baja"}else{if(V.status==1){t.proyecto_modificado.status_texto="Activo"}else{if(V.status==2){t.proyecto_modificado.status_texto="Terminado"}else{if(V.status==3){t.proyecto_modificado.status_texto="Dinero Transferido"}else{if(V.status==4){t.proyecto_modificado.status_texto="Pendiente de Aprobación"}}}}}t.proyecto_modificado.fecha_fin_texto=t.proyecto_modificado.fecha_fin.substr(8,2)+"-"+t.proyecto_modificado.fecha_fin.substr(5,2)+"-"+t.proyecto_modificado.fecha_fin.substr(0,4);i.getByParams("proyecto_id",""+V.proyecto_id,""+true,function(W){t.proyecto_original=W[0];console.log(t.proyecto_original);if(t.proyecto_original.status==0){t.proyecto_original.status_texto="Baja"}else{if(t.proyecto_original.status==1){t.proyecto_original.status_texto="Activo"}else{if(t.proyecto_original.status==2){t.proyecto_original.status_texto="Terminado"}else{if(t.proyecto_original.status==3){t.proyecto_original.status_texto="Dinero Transferido"}else{if(t.proyecto_original.status==4){t.proyecto_original.status_texto="Pendiente de Aprobación"}}}}}t.proyecto_original.fecha_fin_texto=t.proyecto_original.fecha_fin.substr(8,2)+"-"+t.proyecto_original.fecha_fin.substr(5,2)+"-"+t.proyecto_original.fecha_fin.substr(0,4)})}function y(){if(t.proyecto_original.proyecto_id==-1||t.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(t.proyecto_modificado.respuesta==undefined||t.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}t.proyecto_modificado.status_cambio=2;t.proyecto_modificado.aprobador_id=t.user.data.id;t.proyecto_modificado.categorias=[{categoria_id:t.proyecto_modificado.categorias}];console.log(t.proyecto_modificado);i.updateCambio(t.proyecto_modificado,function(V){if(V!=-1){i.update(t.proyecto_modificado,function(W){i.getCambios(function(X){S.sendMail(t.user.data.mail,[{mail:t.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+t.proyecto.nombre,"Su cambio ha sido aprobado",function(Y){console.log(Y)});t.cambios=X;R();w()})})}})}function O(){if(t.proyecto_original.proyecto_id==-1||t.proyecto_modificado.proyecto_id==-1){e.showMessage("error","Debe seleccionar un cambio");return}if(t.proyecto_modificado.respuesta==undefined||t.proyecto_modificado.respuesta.trim().length==0){e.showMessage("error","Debe ingregar una respuesta para el usuario");return}t.proyecto_modificado.status_cambio=0;t.proyecto_modificado.aprobador_id=t.user.data.id;i.updateCambio(t.proyecto_modificado,function(V){i.getCambios(function(W){S.sendMail(t.user.data.mail,[{mail:t.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+t.proyecto.nombre,"Su cambio ha sido cancelado",function(X){console.log(X)});t.cambios=W;R();w()})})}function E(){console.log(t.categoria);if(t.categoria.categoria_id==-1){e.showMessage("error","No ha seleccionado una categoría.");return}var V=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(V){G.update(t.categoria,function(W){})}}function R(){t.proyecto_original={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};t.proyecto_modificado={proyecto_id:-1,descripcion:"",nombre:"",categoria_id:"",status:"",fotos:[]};t.proyecto_original.fotos.push({nombre:"no_image.png"});t.proyecto_original.fotos.push({nombre:"no_image.png"});t.proyecto_original.fotos.push({nombre:"no_image.png"});t.proyecto_original.fotos.push({nombre:"no_image.png"});t.proyecto_modificado.fotos.push({nombre:"no_image.png"});t.proyecto_modificado.fotos.push({nombre:"no_image.png"});t.proyecto_modificado.fotos.push({nombre:"no_image.png"});t.proyecto_modificado.fotos.push({nombre:"no_image.png"})}function u(W){t.categoria=angular.copy(W);var V=angular.element(document.querySelector("#nombre-categoria"));V[0].focus()}function P(){if(t.categoria.parent_id==undefined){t.categoria.parent_id=-1}if(t.categoria.nombre==undefined||t.categoria.nombre.replace(" ","").length==0){e.showMessage("error","El nombre no puede ser vacío");return}if(t.categoria.categoria_id!=-1){G.update(t.categoria,function(V){if(V=="true"){G.get(function(W){t.categorias=W;w()});G.getByParams("parent_id","-1","true",function(W){t.padres=W;w()})}else{}})}else{G.create(t.categoria,function(V){G.get(function(W){t.categorias=W;w()});G.getByParams("parent_id","-1","true",function(W){t.padres=W;w()})})}t.categoria={};t.categoria.categoria_id=-1}function h(V){if(!t.user){M.path("/ingreso");return}V.status=1;s.update(V,function(W){U.getByParams("usuario_id",""+V.donador_id,"true",function(X){S.sendMail(window.mailAdmin,[{mail:X[0].mail}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(Z,Y){console.log(Z);console.log(Y)})});s.get(-1,function(X){t.donaciones=X;I.clearCache=true;i.get(function(Y){})})})}function p(V){if(!t.user){M.path("/ingreso");return}V.status=2;s.update(V,function(W){U.getByParams("usuario_id",""+V.donador_id,"true",function(X){S.sendMail(window.mailAdmin,[{mail:X[0].mail}],"Ariel","PRUEBA","PRUEBA DE CANCELACIÓN DE DONACIÓN",function(Z,Y){console.log(Z);console.log(Y)})});s.get(-1,function(X){t.donaciones=X;I.clearCache=true;i.get(function(Y){})})})}function D(){t.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function T(V){r.uploadImages(V.item(0),"",function(W){i.confirmarDeposito(t.proyecto.proyecto_id,V.item(0).name,function(X){console.log(X);i.get(function(Y){t.proyectos=Y})})})}}function d(){this.screen="administracion/datos.html"}})();