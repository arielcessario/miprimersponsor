(function(){var a=document.getElementsByTagName("script");var b=a[a.length-1].src;angular.module("miprimersponsor.administracion",["ngRoute"]).controller("AdministracionController",c).service("AdministracionService",d);c.$inject=["UserService","AcUtils","ProyectService","$location","UploadService","UploadVars","$scope","DonationService","DonationVars","CategoryService","AdministracionService","AcUtilsGlobals","ContactsService","$timeout","ProyectVars"];function c(O,e,i,H,o,v,m,p,w,B,l,g,M,F,D){var q=this;q.screen=l.screen;q.usuarios=[];q.usuario={usuario_id:-1};q.user=O.getFromToken();q.proyecto={proyecto_id:-1,status:"1",en_slider:"0"};q.proyectos=[];q.showJustificaciones=false;q.foto_01="";q.foto_02="";q.foto_03="";q.foto_04="";q.donaciones_entregadas=[];q.donaciones_obtenidas=[];q.cambios=[];q.padres=[];q.categoria={};q.proyecto_categoria=-1;q.donaciones=[];q.foto_01="no_image.png";q.foto_02="no_image.png";q.foto_03="no_image.png";q.foto_04="no_image.png";q.validation=true;q.modificarUsuario=x;q.resetUsuario=k;q.saveUsuario=n;q.removeUsuario=L;q.updateUsuario=j;q.modificarProyecto=f;q.resetProyecto=C;q.removeProyecto=s;q.createProyecto=G;q.createCambio=I;q.updateFotoProyecto=E;q.selectCambio=A;q.confirmarCambio=u;q.negarCambio=J;q.modificarCategoria=r;q.saveCategoria=K;q.removeCategoria=z;q.resetCategoria=y;q.aprobarDonacion=h;q.subirComprobante=N;if(O.getFromToken()==false){H.path("/ingreso")}m.$watch("administracionCtrl.screen",function(Q,P){if(Q=="administracion/datos.html"){if(q.user.data!=undefined&&q.user.data.rol=="0"){O.getByParams("marcado","0","true",function(R){q.usuarios=R;q.usuario.rol_id="1"})}else{q.usuario=O.getLogged()}}if(Q=="administracion/patrocinadores.html"||Q=="administracion/aportes.html"){w.clearCache=true;q.donaciones_entregadas=[];q.donaciones_obtenidas=[];p.get(q.user.data.id,function(S){for(var R=0;R<S.length;R++){if(S[R].donador_id==q.user.data.id){q.donaciones_entregadas.push(S[R])}else{q.donaciones_obtenidas.push(S[R])}}})}if(Q=="administracion/proyectos.html"){B.get(function(R){q.categorias=R;q.proyecto_categoria=R[0].categoria_id});if(q.user.data.rol==0){i.get(function(S){if(S.length>0){for(var R=0;R<S.length;R++){S[R].costo_inicial=parseFloat(S[R].costo_inicial);S[R].total_donado=parseFloat(S[R].total_donado);S[R].fecha_inicio=new Date(S[R].fecha_inicio);S[R].fecha_fin=new Date(S[R].fecha_fin);S[R].status=""+S[R].status}q.proyectos=S}})}else{i.getByParams("usuario_id",""+q.user.data.id,"true",function(S){if(S.length>0){for(var R=0;R<S.length;R++){S[R].costo_inicial=parseFloat(S[R].costo_inicial);S[R].total_donado=parseFloat(S[R].total_donado);S[R].fecha_inicio=new Date(S[R].fecha_inicio);S[R].fecha_fin=new Date(S[R].fecha_fin);S[R].status=""+S[R].status}q.proyectos=S}})}}if(Q=="administracion/cambios.html"){i.getCambios(function(S){console.log(S);for(var R=0;R<S.length;R++){if(S[R].fotos!="[]"){S[R].fotos=JSON.parse(S[R].fotos)}}q.cambios=S})}if(Q=="administracion/categorias.html"){B.get(function(R){q.categorias=R;q.categoria.categoria_id=-1});B.getByParams("parent_id","-1","true",function(R){q.padres=R})}if(Q=="administracion/donaciones.html"){p.get(-1,function(R){q.donaciones=R})}});function t(){q.validation=false;F(function(){q.validation=true},1)}function x(Q){g.broadcast();q.usuario=angular.copy(Q);q.usuario.rol_id=""+q.usuario.rol_id;q.usuario.calle=""+q.usuario.direcciones[0].calle;var P=angular.element(document.querySelector("#nombre"))}function k(){q.usuario={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};g.broadcast()}function n(){}function L(){var P=confirm("Realmente desea eliminar el usuario? Esta operación no se puede deshacer");if(!P){return}q.usuario.marcado=1;O.update(q.usuario,function(Q){O.getByParams("marcado","0","true",function(R){q.usuarios=R;k();t()})})}function j(){if(q.user.data.rol!=0){q.usuario.rol_id=q.user.data.rol}if(q.usuario.usuario_id==-1){return}O.update(q.usuario,function(P){if(q.user.data.rol==0){O.getByParams("marcado","0","true",function(Q){q.usuarios=Q;k();t();e.showMessage("success","Datos Guardados con Éxito")})}else{q.usuario.password="";O.setLogged(q.usuario);e.showMessage("success","Datos Guardados con Éxito")}})}function f(Q){g.broadcast();q.proyecto=angular.copy(Q);q.proyecto.en_slider=""+q.proyecto.en_slider;q.proyecto_categoria=q.proyecto.categoria_id;var P=angular.element(document.querySelector("#nombre"));q.foto_01=(q.proyecto.fotos[0]!=undefined)?q.proyecto.fotos[0].nombre:"no_image.png";q.foto_02=(q.proyecto.fotos[1]!=undefined)?q.proyecto.fotos[1].nombre:"no_image.png";q.foto_03=(q.proyecto.fotos[2]!=undefined)?q.proyecto.fotos[2].nombre:"no_image.png";q.foto_04=(q.proyecto.fotos[3]!=undefined)?q.proyecto.fotos[3].nombre:"no_image.png";P[0].focus();q.proyecto_categoria=q.proyecto.categoria_id}function C(){q.proyecto={cliente_id:-1,nombre:"",apellido:"",nro_doc:"",telefono:"",password:"",direccion:"",mail:"",rol_id:"0"};q.foto_01="no_image.png";q.foto_02="no_image.png";q.foto_03="no_image.png";q.foto_04="no_image.png";q.showJustificaciones=false}function s(){if(q.proyecto.proyecto_id==-1){e.showMessage("error","Debe seleccionar un proyecto");return}var P=confirm("Realmente desea eliminar el proyecto?");if(!P){return}i.removeProyecto(q.proyecto.cliente_id,function(Q){i.get(function(R){q.proyectos=R})})}function I(){var Q="[";for(var P=0;P<q.proyecto.fotos.length;P++){Q=Q+'{"main":"0","nombre":"'+q.proyecto.fotos[P].nombre+'","folder":"","proyecto_id":"'+q.proyecto.proyecto_id+'"},'}Q=Q.substring(0,Q.length-1);Q=Q+"]";q.proyecto.fotos=Q;q.proyecto.fecha_fin=new Date((q.proyecto.fecha_fin.getMonth()+1)+"/"+(q.proyecto.fecha_fin.getDate())+"/"+q.proyecto.fecha_fin.getFullYear());q.proyecto.status_cambio=1;q.proyecto.usuario_id=q.user.data.id;q.proyecto.categorias=q.proyecto_categoria;i.createCambio(q.proyecto,function(R){console.log(R);v.uploadsList=[];q.proyecto={proyecto_id:-1};q.showJustificaciones=false;t();M.sendMail(q.user.data.mail,[{mail:"arielcessario@gmail.com"}],"MPE","CREACIÓN DE CAMBIO - Proyecto "+q.proyecto.nombre,"Existe un nuevo cambio para aprobar",function(S){console.log(S)})})}function G(){q.proyecto.fotos=[{main:0,nombre:q.foto_01,carpeta:"",proyecto_id:-1},{main:0,nombre:q.foto_02,carpeta:"",proyecto_id:-1},{main:0,nombre:q.foto_03,carpeta:"",proyecto_id:-1},{main:0,nombre:q.foto_04,carpeta:"",proyecto_id:-1}];q.proyecto.categorias=[{categoria_id:q.proyecto_categoria}];q.proyecto.fecha_fin=new Date((q.proyecto.fecha_fin.getMonth()+1)+"/"+(q.proyecto.fecha_fin.getDate())+"/"+q.proyecto.fecha_fin.getFullYear());q.proyecto.usuario_id=q.user.data.id;if(q.proyecto.proyecto_id!=-1){q.showJustificaciones=true;return}i.create(q.proyecto,function(P){if(q.user.data.rol=="0"){i.get(function(Q){q.proyectos=Q;v.uploadsList=[];q.proyecto={proyecto_id:-1};t()})}else{i.getByParams("usuario_id",""+q.user.data.id,"true",function(R){if(R.length>0){for(var Q=0;Q<R.length;Q++){R[Q].costo_inicial=parseFloat(R[Q].costo_inicial);R[Q].total_donado=parseFloat(R[Q].total_donado);R[Q].fecha_inicio=new Date(R[Q].fecha_inicio);R[Q].fecha_fin=new Date(R[Q].fecha_fin);R[Q].status=""+R[Q].status}q.proyectos=R;q.proyecto={proyecto_id:-1}}t()})}})}function E(P,R,Q){o.addImages(P,R,Q,function(T){for(var S=0;S<v.uploadsList.length;S++){if(v.uploadsList[S].id==1){q.foto_01=v.uploadsList[S].file.name}if(v.uploadsList[S].id==2){q.foto_02=v.uploadsList[S].file.name}if(v.uploadsList[S].id==3){q.foto_03=v.uploadsList[S].file.name}if(v.uploadsList[S].id==4){q.foto_04=v.uploadsList[S].file.name}}m.$apply()})}function A(P){q.proyecto_modificado=P;i.getByParams("proyecto_id",""+P.proyecto_id,""+true,function(Q){q.proyecto_original=Q[0];console.log(q.user.data.mail)})}function u(){q.proyecto_modificado.status_cambio=2;q.proyecto_modificado.categorias=[{categoria_id:q.proyecto_modificado.categorias}];console.log(q.proyecto_modificado);i.updateCambio(q.proyecto_modificado,function(P){if(P!=-1){i.update(q.proyecto_modificado,function(Q){i.getCambios(function(R){M.sendMail(q.user.data.mail,[{mail:q.proyecto_original.mail}],"MPE","CONFIRMACIÓN DE CAMBIO - Proyecto "+q.proyecto.nombre,"Su cambio ha sido aprobado",function(S){console.log(S)});q.cambios=R;q.proyecto_original={};q.proyecto_modificado={};t()})})}})}function J(){q.proyecto_modificado.status_cambio=0;i.updateCambio(q.proyecto_modificado,function(P){i.getCambios(function(Q){M.sendMail(q.user.data.mail,[{mail:q.proyecto_original.mail}],"MPE","CANCELACIÓN DE CAMBIO - Proyecto "+q.proyecto.nombre,"Su cambio ha sido cancelado",function(R){console.log(R)});q.cambios=Q;q.proyecto_original={};q.proyecto_modificado={};t()})})}function z(){var P=confirm("Realmente desea eliminar la categoria? Esta operación no tiene deshacer.");if(P){B.remove(q.id,function(Q){})}}function r(Q){q.categoria=angular.copy(Q);var P=angular.element(document.querySelector("#nombre-categoria"));P[0].focus()}function K(){if(q.categoria.parent_id==undefined){q.categoria.parent_id=-1}if(q.categoria.categoria_id!=-1){B.update(q.categoria,function(P){if(P=="true"){B.get(function(Q){q.categorias=Q;t()});B.getByParams("parent_id","-1","true",function(Q){q.padres=Q;t()})}else{}})}else{B.create(q.categoria,function(P){B.get(function(Q){q.categorias=Q;t()});B.getByParams("parent_id","-1","true",function(Q){q.padres=Q;t()})})}q.categoria={};q.categoria.categoria_id=-1}function h(P){if(!q.user){H.path("/ingreso");return}P.status=1;p.update(P,function(Q){M.sendMail("arielcessario@gmail.com",[{mail:"arielcessario@gmail.com"}],"Ariel","PRUEBA","PRUEBA DE CONFIRMACIÓN DE DONACIÓN",function(S,R){console.log(S);console.log(R)});p.get(-1,function(R){q.donaciones=R;D.clearCache=true;i.get(function(S){})})})}function y(){q.categoria={categoria_id:-1,nombre:"",parent_id:-1}}function N(P){o.uploadImages(P.item(0),"",function(Q){i.confirmarDeposito(q.proyecto.proyecto_id,P.item(0).name,function(R){console.log(R);i.get(function(S){q.proyectos=S})})})}}function d(){this.screen="administracion/datos.html"}})();